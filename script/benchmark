#!/usr/bin/env bash

set -e

readonly BUNDLE_GEMFILE="$(pwd)/tmp/bench-site/Gemfile" bundle update

function benchmark() {(
  cd tmp/bench-site
  echo "travis_fold:start:bundle"
  bundle update
  echo "travis_fold:end:bundle"
  time bundle exec jekyll build
)}

echo "travis_fold:start:setup"
rm -rf tmp/benchmark tmp/bench-site
mkdir -p tmp/bench-site
git clone --depth 1 https://github.com/jekyll/benchmarking.git tmp/benchmark
echo "travis_fold:end:setup"

echo "travis_fold:start:generate_site.sh"
tmp/benchmark/generate_site.sh 10 tmp/bench-site
echo "travis_fold:end:generate_site.sh"

cat > tmp/bench-site/Gemfile << EOF
source "https://rubygems.org"
gem "jekyll", :path => "../.."
gem "minima"
EOF

benchmark

cat > tmp/bench-site/Gemfile << EOF
source "https://rubygems.org"
gem "jekyll", :github => "jekyll/jekyll", branch: "master"
gem "minima"
EOF

benchmark
